/*********************************************************************************************************************
* HC-04 蓝牙串口模块驱动实现（带数据包解析）
* 
* 接线说明：
*     HC-04模块          MM32F327单片机
*     VCC        ---->   3.3V
*     GND        ---->   GND
*     TX         ---->   C7 (UART6_RX)
*     RX         ---->   C6 (UART6_TX)
*     RTS        ---->   C13 (可选，HC-04可以不接)
* 
* 数据包格式：
*     包头：[
*     包尾：]
*     示例：[key,1,up]  [slider,1,50]  [joystick,10,-5,0,20]
********************************************************************************************************************/
#include "bluetooth_hc04.h"
#include "zf_driver_uart.h"
#include <stdio.h>
#include <stdarg.h>
#include <string.h>

// ==================== 内部变量 ====================
char    hc04_rx_packet[HC04_RX_PACKET_SIZE];        // 接收数据包缓冲区
uint8   hc04_rx_flag = 0;                           // 接收完成标志位

static uint8    rx_state = 0;                       // 接收状态机：0=等待包头，1=接收数据
static uint8    rx_index = 0;                       // 当前接收位置

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     HC-04 发送单个字节
// 参数说明     data            要发送的字节
// 返回参数     void
// 使用示例     hc04_send_byte(0x5A);
//-------------------------------------------------------------------------------------------------------------------
void hc04_send_byte(const uint8 data)
{
    uart_write_byte(HC04_UART_INDEX, data);
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     HC-04 发送缓冲区数据
// 参数说明     buff            数据缓冲区地址
// 参数说明     len             数据长度
// 返回参数     void
// 使用示例     hc04_send_buffer(buff, 16);
//-------------------------------------------------------------------------------------------------------------------
void hc04_send_buffer(const uint8 *buff, uint32 len)
{
    uart_write_buffer(HC04_UART_INDEX, buff, len);
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     HC-04 发送字符串
// 参数说明     str             字符串地址
// 返回参数     void
// 使用示例     hc04_send_string("Hello World\n");
//-------------------------------------------------------------------------------------------------------------------
void hc04_send_string(const char *str)
{
    uart_write_string(HC04_UART_INDEX, str);
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     HC-04 格式化输出（类似printf）
// 参数说明     format          格式化字符串
// 参数说明     ...             可变参数
// 返回参数     void
// 使用示例     hc04_printf("Speed: %d, Angle: %.2f\n", speed, angle);
// 使用示例     hc04_printf("[display,0,0,Speed:%d]", speed);
// 使用示例     hc04_printf("[plot,%.2f,%.2f]\n", value1, value2);
//-------------------------------------------------------------------------------------------------------------------
void hc04_printf(const char *format, ...)
{
    char buffer[256];                                   // 缓冲区，根据需要调整大小
    va_list args;
    
    va_start(args, format);
    vsnprintf(buffer, sizeof(buffer), format, args);
    va_end(args);
    
    hc04_send_string(buffer);
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     HC-04 串口中断回调函数（数据包解析）
// 参数说明     void
// 返回参数     void
// 使用示例     在 ISR 中的 UART6 中断服务函数中调用
// 备注信息     数据包格式：[tag,param1,param2,...]
//              包头：[    包尾：]
//              本函数实现状态机解析，自动识别包头和包尾
//-------------------------------------------------------------------------------------------------------------------
void hc04_uart_callback(void)
{
    uint8 rx_data;
    
    // 读取串口数据
    if (uart_query_byte(HC04_UART_INDEX, &rx_data))
    {
        if (rx_state == 0)                                  // 状态0：等待包头
        {
            if (rx_data == '[' && hc04_rx_flag == 0)        // 收到包头 '[' 且上一包已处理
            {
                rx_state = 1;                               // 切换到接收数据状态
                rx_index = 0;                               // 重置接收索引
            }
        }
        else if (rx_state == 1)                             // 状态1：接收数据
        {
            if (rx_data == ']')                             // 收到包尾 ']'
            {
                rx_state = 0;                               // 恢复到等待包头状态
                hc04_rx_packet[rx_index] = '\0';            // 添加字符串结束符
                hc04_rx_flag = 1;                           // 标记接收完成
            }
            else                                            // 接收数据
            {
                if (rx_index < HC04_RX_PACKET_SIZE - 1)     // 防止缓冲区溢出
                {
                    hc04_rx_packet[rx_index] = rx_data;     // 存入缓冲区
                    rx_index++;
                }
                else                                        // 缓冲区溢出，放弃本包
                {
                    rx_state = 0;                           // 回到等待包头状态
                }
            }
        }
    }
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     HC-04 初始化
// 参数说明     void
// 返回参数     uint8           初始化状态 0-成功
// 使用示例     hc04_init();
// 备注信息     本函数会初始化UART6，波特率默认9600
//              如需修改波特率，请在 bluetooth_hc04.h 中修改 HC04_BAUDRATE 宏定义
//-------------------------------------------------------------------------------------------------------------------
uint8 hc04_init(void)
{
    // 初始化串口
    uart_init(HC04_UART_INDEX, HC04_BAUDRATE, HC04_RX_PIN, HC04_TX_PIN);
    
    // 使能串口接收中断
    uart_rx_interrupt(HC04_UART_INDEX, 1);
    
    // 清空接收标志
    hc04_rx_flag = 0;
    rx_state = 0;
    rx_index = 0;
    
    return 0;
}
